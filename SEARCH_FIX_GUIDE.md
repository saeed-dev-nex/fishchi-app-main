# 🔍 راهنمای رفع مشکل جستجوی معنایی (Semantic Search)

## 🔴 مشکلات شناسایی شده

### 1. تناقض در نام فیلد Vector
**مشکل**: در مدل `Source.model.js` فیلد vector با نام `searchVector` تعریف شده بود، اما کنترلر جستجو سعی می‌کرد از `contentVector` استفاده کند.

**وضعیت**: ✅ **حل شد** - فیلد در `search.controller.js` اصلاح شد

---

### 2. عدم وجود Vector برای داده‌های موجود
**مشکل**: فقط نت‌ها و منابعی که **بعد از** پیاده‌سازی قابلیت vector ایجاد شده‌اند، دارای vector هستند. داده‌های قبلی vector ندارند و در نتایج جستجو نمایش داده نمی‌شوند.

**راه‌حل**: اجرای اسکریپت تولید خودکار vector برای داده‌های موجود

---

### 3. آستانه شباهت بالا
**مشکل**: آستانه شباهت (similarity threshold) روی `0.7` تنظیم شده بود که خیلی سخت‌گیرانه است.

**وضعیت**: ✅ **حل شد** - آستانه به `0.5` کاهش یافت

---

## 🛠️ راه‌حل‌های پیاده‌سازی شده

### 1. اصلاح کنترلر جستجو ✅
فایل `server/src/controllers/search.controller.js` به‌روزرسانی شد:
- استفاده از `searchVector` برای منابع به جای `contentVector`
- کاهش آستانه شباهت از `0.7` به `0.5`

### 2. ایجاد اسکریپت تولید Vector ✅
فایل `server/src/utils/generateVectors.js` ایجاد شد که:
- تمام نت‌ها و منابع بدون vector را پیدا می‌کند
- برای هر کدام embedding (vector) تولید می‌کند
- وضعیت پیشرفت را نمایش می‌دهد

---

## 📋 مراحل رفع مشکل

### مرحله 1: اطمینان از اجرای سرور
```bash
cd server
pnpm install
pnpm dev
```

### مرحله 2: اجرای اسکریپت تولید Vector
در یک ترمینال جدید:
```bash
cd server
pnpm run generate-vectors
```

**نکته**: این اسکریپت ممکن است بسته به تعداد نت‌ها و منابع شما و محدودیت‌های API هوش مصنوعی، چند دقیقه طول بکشد.

خروجی مثال:
```
🚀 شروع تولید vector برای داده‌های موجود...

📝 15 نت بدون vector پیدا شد.

   ⏳ در حال پردازش نت 673f5a1b2c3d4e5f6a7b8c9d...
   ✅ نت 673f5a1b2c3d4e5f6a7b8c9d با موفقیت آپدیت شد
   ...

✅ نت‌ها: 15 موفق، 0 ناموفق

📚 8 منبع بدون vector پیدا شد.

   ⏳ در حال پردازش منبع 673f5a1b2c3d4e5f6a7b8c9e...
   ✅ منبع 673f5a1b2c3d4e5f6a7b8c9e با موفقیت آپدیت شد
   ...

✅ منابع: 8 موفق، 0 ناموفق

🎉 عملیات تولید vector با موفقیت به پایان رسید!
📊 مجموع: 23 موفق، 0 ناموفق
```

### مرحله 3: تست جستجو
1. برنامه فرانت‌اند را اجرا کنید:
```bash
cd client
pnpm dev
```

2. در صفحه اصلی یا هر صفحه‌ای که SearchBox دارد، عبارتی را جستجو کنید
3. باید نتایج مرتبط را مشاهده کنید

---

## 🔍 نحوه کار سیستم جستجو

### فرآیند جستجوی معنایی:
1. **ورودی کاربر**: کاربر عبارتی را در SearchBox وارد می‌کند
2. **تولید Vector**: عبارت جستجو به یک vector عددی تبدیل می‌شود (با API Google Gemini)
3. **مقایسه**: این vector با تمام vector های نت‌ها و منابع مقایسه می‌شود
4. **محاسبه شباهت**: با استفاده از Cosine Similarity میزان شباهت محاسبه می‌شود
5. **فیلتر**: فقط موارد با شباهت بالاتر از 0.5 برگردانده می‌شوند
6. **مرتب‌سازی**: نتایج بر اساس بیشترین شباهت مرتب می‌شوند

### مزیت جستجوی معنایی نسبت به جستجوی متنی:
- ✅ درک **معنا** و **مفهوم** عبارت، نه فقط کلمات
- ✅ یافتن نتایج **مرتبط** حتی با کلمات متفاوت
- ✅ پشتیبانی از **زبان فارسی** و **انگلیسی**
- ✅ جستجوی هوشمند بر اساس **محتوا** نه فقط عنوان

---

## ⚙️ تنظیمات قابل تغییر

### تغییر آستانه شباهت
فایل: `server/src/controllers/search.controller.js`

```javascript
// خط 45 و 54
if (similarity > 0.5) {  // مقدار قابل تنظیم
```

**توصیه**:
- `0.3-0.4`: نتایج زیاد، ممکن است غیرمرتبط باشند
- `0.5-0.6`: ✅ **توصیه می‌شود** - تعادل خوب بین تعداد و دقت
- `0.7-0.8`: نتایج کم، فقط موارد بسیار مرتبط
- `0.9+`: فقط موارد تقریباً یکسان

---

## 🚨 عیب‌یابی (Troubleshooting)

### مشکل: هیچ نتیجه‌ای برگردانده نمی‌شود
**راه‌حل‌های احتمالی**:
1. ✅ اسکریپت `generate-vectors` را اجرا کنید
2. ✅ مطمئن شوید API Key هوش مصنوعی (Gemini) در `.env` تنظیم شده
3. ✅ لاگ‌های کنسول را بررسی کنید
4. ✅ آستانه شباهت را کاهش دهید (مثلاً به 0.3)

### مشکل: خطای "Failed to generate embedding"
**راه‌حل‌های احتمالی**:
1. ✅ API Key گوگل را بررسی کنید
2. ✅ اتصال اینترنت را چک کنید
3. ✅ محدودیت‌های API (rate limit) را بررسی کنید

### مشکل: جستجو خیلی کند است
**راه‌حل‌های احتمالی**:
1. ⚠️ این روش برای دیتابیس‌های بزرگ کند است
2. 💡 برای production، از MongoDB Atlas Vector Search استفاده کنید
3. 💡 یا از سرویس‌های تخصصی مثل Pinecone، Qdrant استفاده کنید

---

## 📊 بررسی وضعیت Vector ها

برای بررسی اینکه چند نت/منبع دارای vector هستند، می‌توانید این query را در MongoDB Compass یا mongosh اجرا کنید:

```javascript
// تعداد نت‌های دارای vector
db.notes.countDocuments({ vectorGenerated: true })

// تعداد منابع دارای vector
db.sources.countDocuments({ vectorGenerated: true })

// تعداد کل نت‌ها
db.notes.countDocuments()

// تعداد کل منابع
db.sources.countDocuments()
```

---

## 📝 نکات مهم

1. **Vector ها خودکار تولید می‌شوند**: برای نت‌ها و منابع جدید، vector به صورت خودکار در پس‌زمینه تولید می‌شود (با post-save hook)

2. **API Rate Limits**: سرویس Gemini محدودیت تعداد درخواست دارد. اگر داده زیادی دارید، ممکن است نیاز به وقفه بین درخواست‌ها باشید

3. **مصرف فضا**: هر vector حدود 768 عدد float است. برای دیتابیس‌های بزرگ، این حجم قابل توجهی می‌شود

4. **آپدیت محتوا**: اگر محتوای نت یا منبع را تغییر دهید، vector به صورت خودکار دوباره تولید می‌شود

---

## 🎯 چک‌لیست نهایی

- [ ] کد کنترلر جستجو اصلاح شد (استفاده از searchVector برای منابع)
- [ ] آستانه شباهت به 0.5 کاهش یافت
- [ ] اسکریپت generate-vectors اجرا شد
- [ ] تمام نت‌ها و منابع دارای vector شدند (vectorGenerated: true)
- [ ] جستجو در فرانت‌اند تست شد
- [ ] نتایج مرتبط برگردانده می‌شوند

---

## 📞 در صورت نیاز به کمک

اگر باز هم مشکلی وجود داشت:
1. لاگ‌های console را بررسی کنید (هم فرانت و هم بک‌اند)
2. Network tab در DevTools مرورگر را چک کنید
3. مطمئن شوید که route های API به درستی register شده‌اند
4. تست‌های API را با Postman یا curl انجام دهید

---

**تاریخ آخرین به‌روزرسانی**: 20 اکتبر 2025
**نسخه**: 1.0.0
